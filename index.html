<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/12/FLIRT%E6%8A%80%E6%9C%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/12/FLIRT%E6%8A%80%E6%9C%AF/" class="post-title-link" itemprop="url">FLIRT技术</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-04-12 12:32:38 / Modified: 12:33:41" itemprop="dateCreated datePublished" datetime="2022-04-12T12:32:38+08:00">2022-04-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>notion链接：<a target="_blank" rel="noopener" href="https://rainbow-isthmus-f65.notion.site/FLIRT-567adf90e1ef4eba9ec95050195fa34b">https://rainbow-isthmus-f65.notion.site/FLIRT-567adf90e1ef4eba9ec95050195fa34b</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/09/C-%E7%BC%96%E5%86%99socket%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/09/C-%E7%BC%96%E5%86%99socket%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">C++编写socket服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-04-09 21:02:17 / Modified: 21:02:55" itemprop="dateCreated datePublished" datetime="2022-04-09T21:02:17+08:00">2022-04-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>notion链接：</p>
<p><a target="_blank" rel="noopener" href="https://rainbow-isthmus-f65.notion.site/C-socket-c83b3c49d61c4d88bd365ff358043579">https://rainbow-isthmus-f65.notion.site/C-socket-c83b3c49d61c4d88bd365ff358043579</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/04/C-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/04/C-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="post-title-link" itemprop="url">C++面向对象</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-04-04 15:12:32 / Modified: 15:13:17" itemprop="dateCreated datePublished" datetime="2022-04-04T15:12:32+08:00">2022-04-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>notion链接：</p>
<p><a target="_blank" rel="noopener" href="https://rainbow-isthmus-f65.notion.site/C-1367a35122f446cd9e6a4e62bcf80c57">https://rainbow-isthmus-f65.notion.site/C-1367a35122f446cd9e6a4e62bcf80c57</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/03/class%E4%B8%8Estruct%E7%9A%84%E5%8C%BA%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/03/class%E4%B8%8Estruct%E7%9A%84%E5%8C%BA%E5%88%AB/" class="post-title-link" itemprop="url">class与struct的区别</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-04-03 20:23:20 / Modified: 20:24:20" itemprop="dateCreated datePublished" datetime="2022-04-03T20:23:20+08:00">2022-04-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>notion链接：</p>
<p><a target="_blank" rel="noopener" href="https://rainbow-isthmus-f65.notion.site/struct-VS-class-56fec09c1c834de7a1ef306943a3e4ca">https://rainbow-isthmus-f65.notion.site/struct-VS-class-56fec09c1c834de7a1ef306943a3e4ca</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/realloc%E5%87%BD%E6%95%B0%E6%8E%A2%E7%A9%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/31/realloc%E5%87%BD%E6%95%B0%E6%8E%A2%E7%A9%B6/" class="post-title-link" itemprop="url">realloc函数探究</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-03-31 19:37:03 / Modified: 19:38:14" itemprop="dateCreated datePublished" datetime="2022-03-31T19:37:03+08:00">2022-03-31</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Notion地址：<a target="_blank" rel="noopener" href="https://rainbow-isthmus-f65.notion.site/realloc-789f4478bb9f438193a99e735b335162">https://rainbow-isthmus-f65.notion.site/realloc-789f4478bb9f438193a99e735b335162</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/17/SWPU2019wp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/17/SWPU2019wp/" class="post-title-link" itemprop="url">SWPU2019wp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-02-17 17:00:17 / Modified: 18:05:27" itemprop="dateCreated datePublished" datetime="2022-02-17T17:00:17+08:00">2022-02-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>题目地址：<a target="_blank" rel="noopener" href="https://files.buuoj.cn/files/e9761f09f9aac733705d36db1305f015/attachment.exe">https://files.buuoj.cn/files/e9761f09f9aac733705d36db1305f015/attachment.exe</a></p>
<img src="/2022/02/17/SWPU2019wp/image-20220217170202414.png" class="" title="image-20220217170202414">

<p>使用file查看程序，是32的PE可执行文件，拖进IDA</p>
<p>这是main函数的伪代码：</p>
<p>如果第一次反编译的伪代码很奇怪，可以试着用IDA跑一遍程序，再次反编译的代码会清晰很多</p>
<p>main函数的逻辑很清晰，先是将输入与一个字符串循环异或，然后将异或后的结果传入encrypt函数，encrypt函数返回后将加密后的数据与比较数据进行比较</p>
<p>所以接下来的重点就是分析encrypt函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> *v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> *v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> *v7; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> len; <span class="comment">// kr00_4</span></span><br><span class="line">  <span class="keyword">char</span> *v10; <span class="comment">// ecx</span></span><br><span class="line">  __int128 *v11; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> *v12; <span class="comment">// ecx</span></span><br><span class="line">  __int128 *v13; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v14; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">bool</span> v17; <span class="comment">// cf</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v18; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v19; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v20; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v21; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">int</span> *v22; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> *v23; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v25; <span class="comment">// [esp-14h] [ebp-D8h]</span></span><br><span class="line">  <span class="keyword">int</span> v26; <span class="comment">// [esp-10h] [ebp-D4h]</span></span><br><span class="line">  <span class="keyword">void</span> *input[<span class="number">4</span>]; <span class="comment">// [esp+24h] [ebp-A0h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v28; <span class="comment">// [esp+34h] [ebp-90h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v29; <span class="comment">// [esp+38h] [ebp-8Ch]</span></span><br><span class="line">  __int128 cipher[<span class="number">2</span>]; <span class="comment">// [esp+3Ch] [ebp-88h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v31; <span class="comment">// [esp+5Ch] [ebp-68h]</span></span><br><span class="line">  __int128 text; <span class="comment">// [esp+60h] [ebp-64h] BYREF</span></span><br><span class="line">  __int128 v33; <span class="comment">// [esp+70h] [ebp-54h]</span></span><br><span class="line">  <span class="keyword">int</span> v34; <span class="comment">// [esp+80h] [ebp-44h]</span></span><br><span class="line">  <span class="keyword">char</span> key[<span class="number">16</span>]; <span class="comment">// [esp+84h] [ebp-40h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v36[<span class="number">8</span>]; <span class="comment">// [esp+94h] [ebp-30h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v37; <span class="comment">// [esp+C0h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v28 = <span class="number">0</span>;</span><br><span class="line">  v29 = <span class="number">15</span>;</span><br><span class="line">  LOBYTE(input[<span class="number">0</span>]) = <span class="number">0</span>;</span><br><span class="line">  v37 = <span class="number">1</span>;</span><br><span class="line">  v4 = <span class="built_in">printf</span>(v3, <span class="string">&quot;Please input your flag: &quot;</span>);</span><br><span class="line">  sub_83050((<span class="keyword">int</span>)v4);</span><br><span class="line">  <span class="built_in">scanf</span>((<span class="keyword">int</span>)&amp;dword_B0068, input);</span><br><span class="line">  <span class="built_in">strcpy</span>(key, <span class="string">&quot;SWPU_2019_CTF&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v28 == <span class="number">32</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v36[<span class="number">4</span>] = <span class="number">-1173078761</span>;</span><br><span class="line">    v36[<span class="number">5</span>] = <span class="number">494076752</span>;</span><br><span class="line">    v36[<span class="number">6</span>] = <span class="number">-1811652486</span>;</span><br><span class="line">    v36[<span class="number">7</span>] = <span class="number">688582768</span>;</span><br><span class="line">    v8 = <span class="number">0</span>;</span><br><span class="line">    text = <span class="number">0</span>i64;</span><br><span class="line">    v34 = <span class="number">0</span>;</span><br><span class="line">    v33 = <span class="number">0</span>i64;</span><br><span class="line">    len = <span class="built_in">strlen</span>(key);</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v10 = (<span class="keyword">char</span> *)input;</span><br><span class="line">      <span class="keyword">if</span> ( v29 &gt;= <span class="number">0x10</span> )</span><br><span class="line">        v10 = (<span class="keyword">char</span> *)input[<span class="number">0</span>];</span><br><span class="line">      v10[v8] ^= key[v8 % len];                 <span class="comment">// 与字符串异或</span></span><br><span class="line">      ++v8;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v8 &lt; <span class="number">32</span> );</span><br><span class="line">    v11 = (__int128 *)input;</span><br><span class="line">    v7 = (<span class="keyword">char</span> *)input[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> ( v29 &gt;= <span class="number">0x10</span> )</span><br><span class="line">      v11 = (__int128 *)input[<span class="number">0</span>];</span><br><span class="line">    v31 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(cipher, <span class="number">0</span>, <span class="keyword">sizeof</span>(cipher));</span><br><span class="line">    text = *v11;</span><br><span class="line">    v33 = v11[<span class="number">1</span>];</span><br><span class="line">    encrypt(v25, v26, <span class="number">256</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;text, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)cipher);</span><br><span class="line">    v36[<span class="number">0</span>] = <span class="number">-133220429</span>;</span><br><span class="line">    v36[<span class="number">1</span>] = <span class="number">1571732668</span>;</span><br><span class="line">    v12 = v36;</span><br><span class="line">    v36[<span class="number">2</span>] = <span class="number">-2041750854</span>;</span><br><span class="line">    v13 = cipher;</span><br><span class="line">    v36[<span class="number">3</span>] = <span class="number">-748513468</span>;</span><br><span class="line">    v14 = <span class="number">28</span>;</span><br><span class="line">    v36[<span class="number">4</span>] = <span class="number">371505743</span>;</span><br><span class="line">    v36[<span class="number">5</span>] = <span class="number">443719435</span>;</span><br><span class="line">    v36[<span class="number">6</span>] = <span class="number">644704357</span>;</span><br><span class="line">    v36[<span class="number">7</span>] = <span class="number">1741188026</span>;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v15 = *v12;</span><br><span class="line">      <span class="keyword">if</span> ( *v12 != *(_DWORD *)v13 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ++v12;</span><br><span class="line">      v13 = (__int128 *)((<span class="keyword">char</span> *)v13 + <span class="number">4</span>);</span><br><span class="line">      v17 = v14 &lt; <span class="number">4</span>;</span><br><span class="line">      v14 -= <span class="number">4</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v17 )</span><br><span class="line">      &#123;</span><br><span class="line">        v16 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v17 = (<span class="keyword">unsigned</span> __int8)v15 &lt; *(_BYTE *)v13;</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)v15 == *(_BYTE *)v13</span><br><span class="line">      &amp;&amp; (v18 = *((_BYTE *)v12 + <span class="number">1</span>), v17 = v18 &lt; *((_BYTE *)v13 + <span class="number">1</span>), v18 == *((_BYTE *)v13 + <span class="number">1</span>))</span><br><span class="line">      &amp;&amp; (v19 = *((_BYTE *)v12 + <span class="number">2</span>), v17 = v19 &lt; *((_BYTE *)v13 + <span class="number">2</span>), v19 == *((_BYTE *)v13 + <span class="number">2</span>))</span><br><span class="line">      &amp;&amp; (v20 = *((_BYTE *)v12 + <span class="number">3</span>), v17 = v20 &lt; *((_BYTE *)v13 + <span class="number">3</span>), v20 == *((_BYTE *)v13 + <span class="number">3</span>)) )</span><br><span class="line">    &#123;</span><br><span class="line">      v16 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v16 = v17 ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_19:</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">      v21 = <span class="string">&quot;Try again!\r\n&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v21 = <span class="string">&quot;Congratulations! I always knew you could do it.&quot;</span>;</span><br><span class="line">    v22 = <span class="built_in">printf</span>((<span class="keyword">int</span>)v12, v21);</span><br><span class="line">    sub_83050((<span class="keyword">int</span>)v22);</span><br><span class="line">    sub_8ADBE(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="built_in">printf</span>(v5, <span class="string">&quot;Try again!\r\n&quot;</span>);</span><br><span class="line">    sub_83050((<span class="keyword">int</span>)v6);</span><br><span class="line">    sub_8ADBE(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    v7 = (<span class="keyword">char</span> *)input[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v29 &gt;= <span class="number">0x10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v23 = v7;</span><br><span class="line">    <span class="keyword">if</span> ( v29 + <span class="number">1</span> &gt;= <span class="number">0x1000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = (<span class="keyword">char</span> *)*((_DWORD *)v7 - <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v23 - v7 - <span class="number">4</span>) &gt; <span class="number">0x1F</span> )</span><br><span class="line">        _invalid_parameter_noinfo_noreturn();</span><br><span class="line">    &#125;</span><br><span class="line">    sub_864DE(v7);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是encrypt函数的伪代码，远不如main函数清晰，IDA对于函数参数的识别也不尽如人意，勉强可以看出text（即等待加密的数据）被传入了sub_82270这个函数，进入这个函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">encrypt</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">unsigned</span> <span class="keyword">int</span> a4, <span class="keyword">unsigned</span> <span class="keyword">int</span> a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *text; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v9; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v10; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v11; <span class="comment">// esi</span></span><br><span class="line">  _DWORD *v12; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v13; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v14; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">char</span> *v15; <span class="comment">// esi</span></span><br><span class="line">  __m128i v16; <span class="comment">// xmm0</span></span><br><span class="line">  __m128i v17; <span class="comment">// xmm1</span></span><br><span class="line">  __m128i v18; <span class="comment">// xmm0</span></span><br><span class="line">  __m128i v19; <span class="comment">// xmm1</span></span><br><span class="line">  __m128i v20; <span class="comment">// xmm0</span></span><br><span class="line">  __m128i v21; <span class="comment">// xmm1</span></span><br><span class="line">  __m128i v22; <span class="comment">// xmm0</span></span><br><span class="line">  __m128i v23; <span class="comment">// xmm1</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v24; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v25; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> *v26; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v27; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> v28; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v29; <span class="comment">// [esp+20h] [ebp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v30; <span class="comment">// [esp+24h] [ebp-1Ch]</span></span><br><span class="line">  _DWORD *Block; <span class="comment">// [esp+28h] [ebp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> v32[<span class="number">4</span>]; <span class="comment">// [esp+2Ch] [ebp-14h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v6 = a5;</span><br><span class="line">  text = v5;</span><br><span class="line">  v8 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a3 + <span class="number">31</span>) &gt;&gt; <span class="number">5</span>;</span><br><span class="line">  v30 = <span class="number">4</span> * v8;</span><br><span class="line">  Block = <span class="built_in">malloc</span>(<span class="number">4</span> * v8);</span><br><span class="line">  v32[<span class="number">0</span>] = <span class="number">-1839987866</span>;</span><br><span class="line">  v32[<span class="number">1</span>] = <span class="number">120</span>;</span><br><span class="line">  v32[<span class="number">2</span>] = <span class="number">-1839987866</span>;</span><br><span class="line">  v32[<span class="number">3</span>] = <span class="number">120</span>;</span><br><span class="line">  sub_82270(text, (<span class="keyword">unsigned</span> __int8 *)v32);</span><br><span class="line">  sub_820E0();</span><br><span class="line">  sub_82150();</span><br><span class="line">  sub_81F80();</span><br><span class="line">  v29 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v8 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      dword_B0D94 = (<span class="number">2</span> * dword_B0DA4) ^ (<span class="keyword">unsigned</span> __int16)(dword_B0DBC ^ (<span class="number">2</span> * dword_B0DA4));</span><br><span class="line">      dword_B0D78 = (dword_B0DB8 &lt;&lt; <span class="number">16</span>) | ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)dword_B0DAC &gt;&gt; <span class="number">15</span>);</span><br><span class="line">      v9 = (dword_B0D70 &lt;&lt; <span class="number">16</span>) | ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)dword_B0D90 &gt;&gt; <span class="number">15</span>);</span><br><span class="line">      dword_B0D8C = (dword_B0D68 &lt;&lt; <span class="number">16</span>) | ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)dword_B0D84 &gt;&gt; <span class="number">15</span>);</span><br><span class="line">      dword_B0D7C = v9;</span><br><span class="line">      Block[v29] = v9 ^ sub_82150();</span><br><span class="line">      sub_81F80();</span><br><span class="line">      ++v29;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v29 &lt; (<span class="keyword">int</span>)v8 );</span><br><span class="line">    v6 = a5;</span><br><span class="line">  &#125;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v8 )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = a4;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt; <span class="number">0x10</span> || v6 &lt;= a4 + v30 - <span class="number">4</span> &amp;&amp; v6 + v30 - <span class="number">4</span> &gt;= a4 )</span><br><span class="line">    &#123;</span><br><span class="line">      v12 = Block;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v12 = Block;</span><br><span class="line">      <span class="keyword">if</span> ( v6 &gt; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;Block[v8 - <span class="number">1</span>] || v6 + v30 - <span class="number">4</span> &lt; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)Block )</span><br><span class="line">      &#123;</span><br><span class="line">        v13 = a4 + <span class="number">16</span>;</span><br><span class="line">        v12 = Block;</span><br><span class="line">        v14 = v6 + <span class="number">32</span>;</span><br><span class="line">        v15 = (<span class="keyword">char</span> *)Block - a4;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v16 = *(__m128i *)(v13 - <span class="number">16</span>);</span><br><span class="line">          v13 += <span class="number">64</span>;</span><br><span class="line">          v14 += <span class="number">64</span>;</span><br><span class="line">          v17 = _mm_xor_si128(*(__m128i *)&amp;Block[v10], v16);</span><br><span class="line">          v18 = *(__m128i *)(v13 - <span class="number">64</span>);</span><br><span class="line">          *(__m128i *)(v14 - <span class="number">96</span>) = v17;</span><br><span class="line">          v19 = _mm_xor_si128(*(__m128i *)&amp;v15[v13 - <span class="number">64</span>], v18);</span><br><span class="line">          v20 = *(__m128i *)(v13 - <span class="number">48</span>);</span><br><span class="line">          *(__m128i *)(a5 - a4 + v13 - <span class="number">64</span>) = v19;</span><br><span class="line">          v15 = (<span class="keyword">char</span> *)Block - a4;</span><br><span class="line">          v21 = _mm_xor_si128(*(__m128i *)((<span class="keyword">char</span> *)Block + v14 - a5 - <span class="number">64</span>), v20);</span><br><span class="line">          v22 = *(__m128i *)(v13 - <span class="number">32</span>);</span><br><span class="line">          *(__m128i *)(v14 - <span class="number">64</span>) = v21;</span><br><span class="line">          v23 = *(__m128i *)&amp;Block[v10 + <span class="number">12</span>];</span><br><span class="line">          v10 += <span class="number">16</span>;</span><br><span class="line">          *(__m128i *)(v14 - <span class="number">48</span>) = _mm_xor_si128(v23, v22);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v10 &lt; (v8 &amp; <span class="number">0xFFFFFFF0</span>) );</span><br><span class="line">        v6 = a5;</span><br><span class="line">        v11 = a4;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v10 &lt; v8 )</span><br><span class="line">    &#123;</span><br><span class="line">      v24 = v6 - a4;</span><br><span class="line">      v25 = v11 + <span class="number">4</span> * v10;</span><br><span class="line">      v26 = (<span class="keyword">char</span> *)v12 - a4;</span><br><span class="line">      v27 = v8 - v10;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v28 = *(_DWORD *)&amp;v26[v25];</span><br><span class="line">        v25 += <span class="number">4</span>;</span><br><span class="line">        *(_DWORD *)(v24 + v25 - <span class="number">4</span>) = *(_DWORD *)(v25 - <span class="number">4</span>) ^ v28;</span><br><span class="line">        --v27;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v27 );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(Block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sub_82270函数的伪代码，更是令人费解，甚至出现了或运算，这个运算一般是不可逆的！</p>
<p>大致看了一下也不像是什么常见的加密算法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __fastcall <span class="title">sub_82270</span><span class="params">(<span class="keyword">unsigned</span> __int8 *a1, <span class="keyword">unsigned</span> __int8 *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// edi</span></span><br><span class="line">  __int16 v7; <span class="comment">// cx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v9; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v10; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v11; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v12; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v13; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v15; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// [esp+Ch] [ebp-38h]</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// [esp+10h] [ebp-34h]</span></span><br><span class="line">  <span class="keyword">int</span> v19; <span class="comment">// [esp+14h] [ebp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// [esp+18h] [ebp-2Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// [esp+1Ch] [ebp-28h]</span></span><br><span class="line">  <span class="keyword">int</span> v22; <span class="comment">// [esp+20h] [ebp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> v23; <span class="comment">// [esp+24h] [ebp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v24; <span class="comment">// [esp+28h] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v25; <span class="comment">// [esp+2Ch] [ebp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v26; <span class="comment">// [esp+30h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v27; <span class="comment">// [esp+34h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v28; <span class="comment">// [esp+38h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v29; <span class="comment">// [esp+3Ch] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> v30; <span class="comment">// [esp+40h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v2 = *a2 | (*a1 &lt;&lt; <span class="number">23</span>) | <span class="number">0x44D700</span>;</span><br><span class="line">  v22 = a2[<span class="number">1</span>] | (a1[<span class="number">1</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x26BC00</span>;</span><br><span class="line">  v30 = a2[<span class="number">2</span>] | (a1[<span class="number">2</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x626B00</span>;</span><br><span class="line">  v21 = a2[<span class="number">3</span>] | (a1[<span class="number">3</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x135E00</span>;</span><br><span class="line">  v3 = a2[<span class="number">4</span>] | (a1[<span class="number">4</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x578900</span>;</span><br><span class="line">  v29 = a2[<span class="number">5</span>] | (a1[<span class="number">5</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x35E200</span>;</span><br><span class="line">  v20 = a2[<span class="number">6</span>] | (a1[<span class="number">6</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x713500</span>;</span><br><span class="line">  v28 = a2[<span class="number">7</span>] | (a1[<span class="number">7</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x9AF00</span>;</span><br><span class="line">  v19 = a2[<span class="number">8</span>] | (a1[<span class="number">8</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x4D7800</span>;</span><br><span class="line">  v27 = a2[<span class="number">9</span>] | (a1[<span class="number">9</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x2F1300</span>;</span><br><span class="line">  v26 = a2[<span class="number">10</span>] | (a1[<span class="number">10</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x6BC400</span>;</span><br><span class="line">  v25 = a2[<span class="number">11</span>] | (a1[<span class="number">11</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x1AF100</span>;</span><br><span class="line">  v18 = a2[<span class="number">12</span>] | (a1[<span class="number">12</span>] &lt;&lt; <span class="number">23</span>) | <span class="number">0x5E2600</span>;</span><br><span class="line">  v4 = a2[<span class="number">13</span>] | (a1[<span class="number">13</span>] &lt;&lt; <span class="number">23</span>);</span><br><span class="line">  dword_B0D9C = <span class="number">0</span>;</span><br><span class="line">  v24 = v4 | <span class="number">0x3C4D00</span>;</span><br><span class="line">  v5 = a2[<span class="number">14</span>] | (a1[<span class="number">14</span>] &lt;&lt; <span class="number">23</span>);</span><br><span class="line">  dword_B0DB4 = <span class="number">0</span>;</span><br><span class="line">  v23 = v5 | <span class="number">0x789A00</span>;</span><br><span class="line">  v6 = a1[<span class="number">15</span>];</span><br><span class="line">  v7 = v23;</span><br><span class="line">  v17 = <span class="number">32</span>;</span><br><span class="line">  v8 = a2[<span class="number">15</span>] | (v6 &lt;&lt; <span class="number">23</span>) | <span class="number">0x47AC00</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    dword_B0D94 = (<span class="number">2</span> * v8) ^ (<span class="keyword">unsigned</span> __int16)(v7 ^ (<span class="number">2</span> * v8));</span><br><span class="line">    dword_B0D78 = (v27 &gt;&gt; <span class="number">15</span>) | (v25 &lt;&lt; <span class="number">16</span>);</span><br><span class="line">    dword_B0D8C = (v29 &gt;&gt; <span class="number">15</span>) | (v28 &lt;&lt; <span class="number">16</span>);</span><br><span class="line">    dword_B0D7C = (v2 &gt;&gt; <span class="number">15</span>) | (v30 &lt;&lt; <span class="number">16</span>);</span><br><span class="line">    v9 = ((v2 + (((v2 &lt;&lt; <span class="number">8</span>) | (v2 &gt;&gt; <span class="number">23</span>)) &amp; <span class="number">0x7FFFFFFF</span>)) &amp; <span class="number">0x7FFFFFFF</span>)</span><br><span class="line">       + ((v2 + (((v2 &lt;&lt; <span class="number">8</span>) | (v2 &gt;&gt; <span class="number">23</span>)) &amp; <span class="number">0x7FFFFFFF</span>)) &gt;&gt; <span class="number">31</span>)</span><br><span class="line">       + (((v3 &gt;&gt; <span class="number">11</span>) | (v3 &lt;&lt; <span class="number">20</span>)) &amp; <span class="number">0x7FFFFFFF</span>);</span><br><span class="line">    v10 = (v9 &amp; <span class="number">0x7FFFFFFF</span>) + (v9 &gt;&gt; <span class="number">31</span>) + (((v26 &gt;&gt; <span class="number">10</span>) | (v26 &lt;&lt; <span class="number">21</span>)) &amp; <span class="number">0x7FFFFFFF</span>);</span><br><span class="line">    v11 = (v10 &amp; <span class="number">0x7FFFFFFF</span>) + (v10 &gt;&gt; <span class="number">31</span>) + (((v24 &lt;&lt; <span class="number">17</span>) | (v24 &gt;&gt; <span class="number">14</span>)) &amp; <span class="number">0x7FFFFFFF</span>);</span><br><span class="line">    v12 = (v11 &amp; <span class="number">0x7FFFFFFF</span>) + (v11 &gt;&gt; <span class="number">31</span>) + (((v8 &lt;&lt; <span class="number">15</span>) | HIWORD(v8)) &amp; <span class="number">0x7FFFFFFF</span>);</span><br><span class="line">    v13 = (v12 &amp; <span class="number">0x7FFFFFFF</span>) + (v12 &gt;&gt; <span class="number">31</span>) + ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)sub_82150() &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    v2 = v22;</span><br><span class="line">    v22 = v30;</span><br><span class="line">    dword_B0D88 = v30;</span><br><span class="line">    v30 = v21;</span><br><span class="line">    dword_B0D70 = v21;</span><br><span class="line">    v14 = v3;</span><br><span class="line">    v3 = v29;</span><br><span class="line">    v21 = v14;</span><br><span class="line">    dword_B0DB0 = v14;</span><br><span class="line">    v29 = v20;</span><br><span class="line">    dword_B0D84 = v20;</span><br><span class="line">    v20 = v28;</span><br><span class="line">    dword_B0D98 = v28;</span><br><span class="line">    v28 = v19;</span><br><span class="line">    dword_B0D68 = v19;</span><br><span class="line">    v19 = v27;</span><br><span class="line">    dword_B0D74 = v27;</span><br><span class="line">    v27 = v26;</span><br><span class="line">    dword_B0DAC = v26;</span><br><span class="line">    v26 = v25;</span><br><span class="line">    dword_B0D6C = v25;</span><br><span class="line">    v25 = v18;</span><br><span class="line">    dword_B0DB8 = v18;</span><br><span class="line">    v18 = v24;</span><br><span class="line">    dword_B0DA0 = v24;</span><br><span class="line">    v24 = v23;</span><br><span class="line">    dword_B0DA8 = v23;</span><br><span class="line">    v7 = v8;</span><br><span class="line">    v23 = v8;</span><br><span class="line">    v15 = v13 &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    result = v13 &amp; <span class="number">0x7FFFFFFF</span>;</span><br><span class="line">    v8 = result + v15;</span><br><span class="line">    dword_B0DBC = v23;</span><br><span class="line">    --v17;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v17 );</span><br><span class="line">  dword_B0DA4 = v8;</span><br><span class="line">  dword_B0D90 = v2;</span><br><span class="line">  dword_B0D80 = v3;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>像这种看起来很复杂，又不是常见的加密算法的，我们其实只需要关注数据的变化，使用内存硬件断点就可以达到这个目的</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217173021503.png" class="" title="image-20220217173021503">

<p>先把程序跑起来，输入一串字符，最好有规律一点，这个题目会在输入后判断字符的长度是否为32，所以我们输入的长度要是32</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217173324894.png" class="" title="image-20220217173324894">

<p>在这个循环中，将输入与一个常量字符串“SWPU_2019_CTF”循环异或</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217173539165.png" class="" title="image-20220217173539165">

<p>异或后的数据保存在这里，第一个字符b是已经异或过的结果，在b的位置下一个硬件断点，按F2即可</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217173713068.png" class="" title="image-20220217173713068">

<p>勾选上Hardware，因为是数据，所以下面的复选框中我们勾选Read和Write即可</p>
<p>然后F9运行程序，断在了这里</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217173847732.png" class="" title="image-20220217173847732">

<img src="/2022/02/17/SWPU2019wp/image-20220217173957563.png" class="" title="image-20220217173957563">

<p>查看text的内存发现这里的操作是将异或后的数据拷贝到text中，所以在text的内存位置我们也要下一个硬件断点，之前下的那个硬件断点删不删都行</p>
<p>再次F9运行程序，断在了这里</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217174255390.png" class="" title="image-20220217174255390">

<p>这个循环将[eax-4]中的数据与ecx进行异或，查看内存发现[eax-4]的数据就是text的数据</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217174423037.png" class="" title="image-20220217174423037">

<p>所以这个循环就是将text异或，然后存入[ebx+eax-4]的地址，在这里我们继续下一个硬件断点</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217174650793.png" class="" title="image-20220217174650793">

<p>然后F9运行，程序断在这里：</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217174815088.png" class="" title="image-20220217174815088">

<p>这里已经是最后比较数据的地方了，所以其实输出的数据只是经过了两次异或加密，那些复杂的算式可能只是为了产生异或的数据，有了这个猜测，我们可以在异或的地址处下断点，检查不同的输入是否会产生相同的异或数据</p>
<p>第一次异或的数据是一个常量字符串，我们不用关心，第二次异或的数据我们倒是不清楚，所以在这里下一个断点</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217175155775.png" class="" title="image-20220217175155775">

<p>然后运行两次，输入不同的数据</p>
<img src="/2022/02/17/SWPU2019wp/image-20220217175314851.png" class="" title="image-20220217175314851">

<img src="/2022/02/17/SWPU2019wp/image-20220217175404881.png" class="" title="image-20220217175404881">

<p>查看两次运行的内存发现是一样的，所以异或的数据与我们的输入无关</p>
<p>我们把异或的数据提取出来</p>
<p><strong>[0x86, 0x0C, 0x3E, 0xCA, 0x98, 0xD7, 0xAE, 0x19, 0xE2, 0x77, 0x6B, 0xA6, 0x6A, 0xA1, 0x77, 0xB0, 0x69, 0x91, 0x37, 0x05, 0x7A, 0xF9, 0x7B, 0x30, 0x43, 0x5A, 0x4B, 0x10, 0x86, 0x7D, 0xD4, 0x28]</strong></p>
<p>第一次异或的数据是常量字符串“SWPU_2019_CTF”</p>
<p>比较的数据是：</p>
<p><strong>[0xB3, 0x37, 0x0F, 0xF8, 0xBC, 0xBC, 0xAE, 0x5D, 0xBA, 0x5A, 0x4D, 0x86, 0x44, 0x97, 0x62, 0xD3, 0x4F, 0xBA, 0x24, 0x16, 0x0B, 0x9F, 0x72, 0x1A, 0x65, 0x68, 0x6D, 0x26, 0xBA, 0x6B, 0xC8, 0x67]</strong></p>
<p>解密脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmp = [<span class="number">0xB3</span>, <span class="number">0x37</span>, <span class="number">0x0F</span>, <span class="number">0xF8</span>, <span class="number">0xBC</span>, <span class="number">0xBC</span>, <span class="number">0xAE</span>, <span class="number">0x5D</span>, <span class="number">0xBA</span>, <span class="number">0x5A</span>, <span class="number">0x4D</span>, <span class="number">0x86</span>, <span class="number">0x44</span>, <span class="number">0x97</span>, <span class="number">0x62</span>, <span class="number">0xD3</span>, <span class="number">0x4F</span>, <span class="number">0xBA</span>, <span class="number">0x24</span>, <span class="number">0x16</span>, <span class="number">0x0B</span>, <span class="number">0x9F</span>, <span class="number">0x72</span>, <span class="number">0x1A</span>, <span class="number">0x65</span>, <span class="number">0x68</span>, <span class="number">0x6D</span>, <span class="number">0x26</span>, <span class="number">0xBA</span>, <span class="number">0x6B</span>, <span class="number">0xC8</span>, <span class="number">0x67</span>]</span><br><span class="line">xor_data2 = [<span class="number">0x86</span>, <span class="number">0x0C</span>, <span class="number">0x3E</span>, <span class="number">0xCA</span>, <span class="number">0x98</span>, <span class="number">0xD7</span>, <span class="number">0xAE</span>, <span class="number">0x19</span>, <span class="number">0xE2</span>, <span class="number">0x77</span>, <span class="number">0x6B</span>, <span class="number">0xA6</span>, <span class="number">0x6A</span>, <span class="number">0xA1</span>, <span class="number">0x77</span>, <span class="number">0xB0</span>, <span class="number">0x69</span>, <span class="number">0x91</span>, <span class="number">0x37</span>, <span class="number">0x05</span>, <span class="number">0x7A</span>, <span class="number">0xF9</span>, <span class="number">0x7B</span>, <span class="number">0x30</span>, <span class="number">0x43</span>, <span class="number">0x5A</span>, <span class="number">0x4B</span>, <span class="number">0x10</span>, <span class="number">0x86</span>, <span class="number">0x7D</span>, <span class="number">0xD4</span>, <span class="number">0x28</span>]</span><br><span class="line">xor_data1 = <span class="string">&quot;SWPU_2019_CTF&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(cmp)):</span><br><span class="line">    cmp[i] ^= xor_data2[i]</span><br><span class="line">    cmp[i] ^= <span class="built_in">ord</span>(xor_data1[i % <span class="built_in">len</span>(xor_data1)])</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(cmp[i]), end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<img src="/2022/02/17/SWPU2019wp/image-20220217180301719.png" class="" title="image-20220217180301719">

<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>当遇到加密函数很复杂而且不是常见的加密算法时，我们可以先使用硬件断点将输入的变化过程分析出来，这可以避免去分析一些与外部变量无关的代码，大大节省解题时间</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">C++逆向分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-02-03 20:08:34 / Modified: 21:12:58" itemprop="dateCreated datePublished" datetime="2022-02-03T20:08:34+08:00">2022-02-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="识别C-程序"><a href="#识别C-程序" class="headerlink" title="识别C++程序"></a>识别C++程序</h2><p>C++程序的反汇编代码会呈现一些特殊之处，通过这些特征我们可以识别一个二进制文件是否是由C++编写</p>
<h3 id="频繁使用ecx寄存器（this指针）"><a href="#频繁使用ecx寄存器（this指针）" class="headerlink" title="频繁使用ecx寄存器（this指针）"></a>频繁使用ecx寄存器（this指针）</h3><p>在函数调用之前，ecx被赋值为this指针</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203202812061.png" class="" title="image-20220203202812061">

<p>如果一个函数在使用ecx之前没有初始化他，这个函数可能是一个类成员函数</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203203023075.png" class="" title="image-20220203203023075">

<h3 id="调用约定"><a href="#调用约定" class="headerlink" title="调用约定"></a>调用约定</h3><p>如果一个函数调用完成后，eax被赋值给ecx，紧接着调用另一个函数</p>
<p>前一个函数可能是在实例化一个类，后一个函数可能是该类的构造函数</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203203238411.png" class="" title="image-20220203203238411">

<p>在C++程序中，虚函数的调用往往是隐式的</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203203329150.png" class="" title="image-20220203203329150">

<h3 id="STL代码和导入的DLL"><a href="#STL代码和导入的DLL" class="headerlink" title="STL代码和导入的DLL"></a>STL代码和导入的DLL</h3><p>在IDA的import窗口可以查看程序导入的DLL，根据名称判断是否是C++程序</p>
<p>STL函数的调用：</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203203555331.png" class="" title="image-20220203203555331">

<h2 id="类实例布局"><a href="#类实例布局" class="headerlink" title="类实例布局"></a>类实例布局</h2><h3 id="一般的类"><a href="#一般的类" class="headerlink" title="一般的类"></a>一般的类</h3><p>在C++中实例化一个类：</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203210140767.png" class="" title="image-20220203210140767">

<p>这个类在内存中的布局是这样的：</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203210215757.png" class="" title="image-20220203210215757">

<p>为了对齐四字节的地址，最后一个变量的结尾会被填充一个三字节的垃圾数据</p>
<h3 id="含有虚函数的类"><a href="#含有虚函数的类" class="headerlink" title="含有虚函数的类"></a>含有虚函数的类</h3><p>如果一个类中包含有虚函数</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203210453882.png" class="" title="image-20220203210453882">

<p>这个类在内存中的布局会是这样</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203210546156.png" class="" title="image-20220203210546156">

<p>在布局的最前方会加入一个vfptr，这里保存虚函数表的地址，这个地址指向的内存记录了每个虚函数的地址</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203210653110.png" class="" title="image-20220203210653110">

<h3 id="单继承的类"><a href="#单继承的类" class="headerlink" title="单继承的类"></a>单继承的类</h3><p>如果一个类单继承另一个类</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203210739872.png" class="" title="image-20220203210739872">

<p>这个类在内存中的布局会是这样</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203210807134.png" class="" title="image-20220203210807134">

<p>仅仅是将派生类的成员变量添加在父类的后面</p>
<h3 id="多继承的类"><a href="#多继承的类" class="headerlink" title="多继承的类"></a>多继承的类</h3><img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203210943066.png" class="" title="image-20220203210943066">

<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203210957377.png" class="" title="image-20220203210957377">

<p>这个类在内存中的布局：</p>
<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203211022313.png" class="" title="image-20220203211022313">

<img src="/2022/02/03/C-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/image-20220203211032710.png" class="" title="image-20220203211032710">

<p>与单继承大同小异，子类的成员变量添加在父类后面</p>
<p>另外，子类的虚函数会添加到第一个父类的虚函数表中</p>
<h2 id="识别类"><a href="#识别类" class="headerlink" title="识别类"></a>识别类</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/02/%E4%B8%80%E9%81%93VM%E5%85%A5%E9%97%A8%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/02/%E4%B8%80%E9%81%93VM%E5%85%A5%E9%97%A8%E9%A2%98/" class="post-title-link" itemprop="url">一道VM入门题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-02-02 21:01:44" itemprop="dateCreated datePublished" datetime="2022-02-02T21:01:44+08:00">2022-02-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-02-03 20:07:29" itemprop="dateModified" datetime="2022-02-03T20:07:29+08:00">2022-02-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>玩逆向半年了，还是菜的发慌，本来想RE和PWN双修，无奈发现精力跟不上，目前的想法是先把RE该学的学了，有空的话PWN的常规知识也要学一下，实话实说PWN有点难，学起来不如RE快</p>
<p>寒假在家闲，最近开始接触虚拟机逆向，从一道简单的虚拟机逆向开始</p>
<p>ida打开程序，在函数窗口搜索main，发现没有main函数，但是在invoke_main中发现了_main，跳过去发现是main函数里面有花指令，修一下就好</p>
<img src="/2022/02/02/%E4%B8%80%E9%81%93VM%E5%85%A5%E9%97%A8%E9%A2%98/image-20220202211002824.png" class="" title="image-20220202211002824">

<p>nop掉一个花指令，就可以反编译了</p>
<img src="/2022/02/02/%E4%B8%80%E9%81%93VM%E5%85%A5%E9%97%A8%E9%A2%98/image-20220202211200623.png" class="" title="image-20220202211200623">

<p>main函数伪代码：</p>
<p>这是我修改过后的伪代码，对一些变量的名称进行了修改，使伪代码更加易懂</p>
<p>最外层是一个死循环，死循环中嵌套了一个小的for循环，for循环的作用是读取opcode与option_index进行比较，如果比较相同的话就退出for循环</p>
<p>显然如果循环退出，那么接下来的option[i]调用的函数必定是opcode[vm_eip]对应的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+10h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  sub_4F14F0();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_2:</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; i += <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( i &gt;= <span class="number">0x58</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">      <span class="keyword">if</span> ( option_index[<span class="number">4</span> * i] == opcode[vm_eip] )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    option[i]();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以题目的关键就在于opcode以及其对应的option，我们进入option一个一个分析</p>
<p>这里是我分析好的option，随便挑几个说一下</p>
<img src="/2022/02/02/%E4%B8%80%E9%81%93VM%E5%85%A5%E9%97%A8%E9%A2%98/image-20220202211936784.png" class="" title="image-20220202211936784">

<h3 id="vm-xor-reg"><a href="#vm-xor-reg" class="headerlink" title="vm_xor_reg"></a>vm_xor_reg</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vm_xor_reg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *v0; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> reg_index; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v0 = reg[(<span class="keyword">unsigned</span> __int8)first[vm_eip]];</span><br><span class="line">  reg_index = (<span class="keyword">unsigned</span> __int8)second[vm_eip];</span><br><span class="line">  vm_eip += <span class="number">3</span>;</span><br><span class="line">  result = *reg[reg_index];</span><br><span class="line">  *v0 ^= result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vm_eip不用解释了吧，这是程序的计数器，在调试的时候可以推测出来</p>
<p>那first和second又是什么呢？</p>
<p>先看下面，有一条指令是vm_eip += 3，由此可以推断出一条opcode的长度是三个字节</p>
<p>这些就是opcode，他们的组成是：option_index | first | second</p>
<ol>
<li>option_index：对应的option的编号</li>
<li>first：前一个操作数</li>
<li>second：后一个操作数</li>
</ol>
<img src="/2022/02/02/%E4%B8%80%E9%81%93VM%E5%85%A5%E9%97%A8%E9%A2%98/image-20220202212457496.png" class="" title="image-20220202212457496">

<p>所以first[vm_eip]就相当于取前一个操作数，second同理</p>
<p>reg是一个数组，我们在这里可以把它看成是寄存器数组</p>
<p>变量都解释清楚了，那么这个函数的行为就显而易见了：</p>
<p><strong>以first和second为下标取两个寄存器的值异或，并把结果放到第一个寄存器中</strong></p>
<h3 id="vm-set-zflag"><a href="#vm-set-zflag" class="headerlink" title="vm_set_zflag"></a>vm_set_zflag</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vm_set_zflag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *v0; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> reg_index; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v0 = reg[(<span class="keyword">unsigned</span> __int8)second[vm_eip]];</span><br><span class="line">  reg_index = (<span class="keyword">unsigned</span> __int8)first[vm_eip];</span><br><span class="line">  vm_eip += <span class="number">3</span>;</span><br><span class="line">  vm_zflag = *reg[reg_index] - *v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他的都解释过了，这个vm_zflag是怎么来的呢？</p>
<p>我们查看vm_zflag的交叉引用，发现他出现在另一个函数中，在这个函数中，vm_zflag被当成了跳转的条件，所以推测这个变量是zflag，用两个数相减来得到zflag的值也合乎情理</p>
<h3 id="vm-jz"><a href="#vm-jz" class="headerlink" title="vm_jz"></a>vm_jz</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vm_jz</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( vm_zflag )</span><br><span class="line">  &#123;</span><br><span class="line">    vm_eip += <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">3</span> * (<span class="keyword">unsigned</span> __int8)first[vm_eip] - <span class="number">3</span>;</span><br><span class="line">    vm_eip = result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="vm-push-reg"><a href="#vm-push-reg" class="headerlink" title="vm_push_reg"></a>vm_push_reg</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vm_push_reg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> reg_index; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  reg_index = (<span class="keyword">unsigned</span> __int8)first[vm_eip];</span><br><span class="line">  ++stack_offset;</span><br><span class="line">  vm_eip += <span class="number">3</span>;</span><br><span class="line">  stack_base[stack_offset] = *(_BYTE *)reg[reg_index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>stack_base也是根据调试推断出来的，有了这个名称，这个函数很容易就可以理解为push_reg</p>
<p>分析这些option的时候，前面会很难懂，但是当你理解了一些变量代表的含义并赋予他们恰当的名字，后面的分析就可以变得很快</p>
<p>一些变量的初始化：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">sub_4F14F0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v0; <span class="comment">// esi</span></span><br><span class="line"></span><br><span class="line">  input_len = <span class="number">0</span>;</span><br><span class="line">  yushu = <span class="number">0</span>;</span><br><span class="line">  dword_535BD4 = <span class="number">0</span>;</span><br><span class="line">  vm_zflag = <span class="number">0</span>;</span><br><span class="line">  stack_offset = <span class="number">0</span>;</span><br><span class="line">  dword_535BD0 = <span class="number">0</span>;</span><br><span class="line">  vm_eip = <span class="number">0</span>;</span><br><span class="line">  stack_base = <span class="built_in">malloc</span>(<span class="number">0x100</span>u);</span><br><span class="line">  v0 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x100</span>u);</span><br><span class="line">  input = v0;</span><br><span class="line">  <span class="built_in">memset</span>(stack_base, <span class="number">0</span>, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memset</span>(v0, <span class="number">0</span>, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，我们要做的就是将opcode翻译成这些option，编写一个翻译脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">opcode = [<span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x03</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x11</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x11</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x0D</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x11</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x0D</span>, <span class="number">0x2B</span>, <span class="number">0x00</span>, <span class="number">0x14</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x61</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x10</span>, <span class="number">0x1A</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x7A</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x0F</span>, <span class="number">0x1A</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x47</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x06</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x24</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x41</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x10</span>, <span class="number">0x24</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x5A</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x0F</span>, <span class="number">0x24</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x4B</span>, <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x10</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x06</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x0D</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x0D</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x0F</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x09</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x0F</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x13</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0C</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x0E</span>, <span class="number">0x5B</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x22</span>, <span class="number">0x0C</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x0D</span>, <span class="number">0x59</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x06</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x0B</span>, <span class="number">0x4E</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x05</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0x00</span>, <span class="number">0x00</span>]</span><br><span class="line"><span class="comment"># print(len(opcode))</span></span><br><span class="line"></span><br><span class="line">eip = <span class="number">0</span></span><br><span class="line">stack_base = [<span class="number">0</span>] * <span class="number">0x100</span></span><br><span class="line">stack_offset = <span class="number">0</span></span><br><span class="line">input_len = <span class="number">0</span></span><br><span class="line">yushu = <span class="number">0</span></span><br><span class="line">zflag = <span class="number">0</span></span><br><span class="line"><span class="built_in">input</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x5d</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;%02d&#x27;</span> % (i+<span class="number">1</span>), end=<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">    each_opcode = opcode[eip:eip+<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;nop&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;mov reg[%d], %d&#x27;</span> % (each_opcode[<span class="number">1</span>], each_opcode[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;push %d&#x27;</span> % (each_opcode[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;push reg[%d]&#x27;</span> % (each_opcode[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;pop reg[%d]&#x27;</span> % (each_opcode[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;print message&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">6</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;add reg[%d], reg[%d]&#x27;</span> % (each_opcode[<span class="number">1</span>], each_opcode[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">7</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;sub reg[%d], reg[%d]&#x27;</span> % (each_opcode[<span class="number">1</span>], each_opcode[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">8</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;mul reg[%d], reg[%d]&#x27;</span> % (each_opcode[<span class="number">1</span>], each_opcode[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">9</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;div reg[%d], reg[%d]&#x27;</span> % (each_opcode[<span class="number">1</span>], each_opcode[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0xa</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;xor reg[%d], reg[%d]&#x27;</span> % (each_opcode[<span class="number">1</span>], each_opcode[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0xb</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;jmp %d&#x27;</span> % (each_opcode[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0xc</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;zflag = reg[%d] - reg[%d]&#x27;</span> % (each_opcode[<span class="number">1</span>] , each_opcode[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0xd</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;jz %d&#x27;</span> % (each_opcode[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0xe</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;jnz %d&#x27;</span> % (each_opcode[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0xf</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;jg %d&#x27;</span> % (each_opcode[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0x10</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;jl %d&#x27;</span> % (each_opcode[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0x11</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;gets input&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0x12</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;memset(input[%d, 0, %d])&#x27;</span> % (each_opcode[<span class="number">1</span>], each_opcode[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0x13</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;load reg[%d], stack[reg[%d]]&#x27;</span> % (each_opcode[<span class="number">1</span>], each_opcode[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0x14</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;load reg[%d], input[reg[%d]]&#x27;</span> % (each_opcode[<span class="number">1</span>], each_opcode[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">if</span> each_opcode[<span class="number">0</span>] == <span class="number">0xff</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;exit&#x27;</span>)</span><br><span class="line">    eip += <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>以下是翻译脚本的输出，我分析后添加了一些注释</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">01: mov reg[3], 3</span><br><span class="line">02: print message ;print p;z input:</span><br><span class="line"></span><br><span class="line">03: gets input    ;put input length into reg[0]</span><br><span class="line"></span><br><span class="line">04: mov reg[1], 17</span><br><span class="line">05: zflag = reg[0] - reg[1] ;input length shou be 17</span><br><span class="line">06: jz 10</span><br><span class="line"></span><br><span class="line">07: mov reg[3], 1</span><br><span class="line">08: print message ;print wrong</span><br><span class="line"></span><br><span class="line">09: exit</span><br><span class="line"></span><br><span class="line">10: mov reg[2], 0</span><br><span class="line">11: mov reg[0], 17</span><br><span class="line">12: zflag = reg[0] - reg[2] ;set cycle index to 17</span><br><span class="line">13: jz 43 </span><br><span class="line"></span><br><span class="line">14: load reg[0], input[reg[2]] ;mov each input byte to reg[0]</span><br><span class="line">15: mov reg[1], 97 ;ascii &#x27;a&#x27;</span><br><span class="line">16: zflag = reg[0] - reg[1] ;Determine whether the value is less than charactor &#x27;a&#x27;</span><br><span class="line">17: jl 26</span><br><span class="line"></span><br><span class="line">18: mov reg[1], 122 ;ascii &#x27;z&#x27;</span><br><span class="line">19: zflag = reg[0] - reg[1] ;Determine whether the value is more than charactor &#x27;z&#x27;</span><br><span class="line">20: jg 26</span><br><span class="line"></span><br><span class="line">21: mov reg[1], 71 ;input char is in &#x27;a&#x27; ~ &#x27;z&#x27;</span><br><span class="line">22: xor reg[0], reg[1]</span><br><span class="line">23: mov reg[1], 1</span><br><span class="line">24: add reg[0], reg[1] ;input char = (input char ^ 71) + 1 </span><br><span class="line">25: jmp 36</span><br><span class="line"></span><br><span class="line">26: mov reg[1], 65 ;ascii &#x27;A&#x27;</span><br><span class="line">27: zflag = reg[0] - reg[1]</span><br><span class="line">28: jl 36</span><br><span class="line"></span><br><span class="line">29: mov reg[1], 90 ;asscii &#x27;Z&#x27;</span><br><span class="line">30: zflag = reg[0] - reg[1]</span><br><span class="line">31: jg 36</span><br><span class="line"></span><br><span class="line">32: mov reg[1], 75 ;input char is in &#x27;A&#x27; ~ &#x27;Z&#x27;</span><br><span class="line">33: xor reg[0], reg[1]</span><br><span class="line">34: mov reg[1], 1</span><br><span class="line">35: sub reg[0], reg[1]</span><br><span class="line"></span><br><span class="line">36: mov reg[1], 16</span><br><span class="line">37: div reg[0], reg[1] ;input char / 16,  </span><br><span class="line">38: push reg[1] ;remainder</span><br><span class="line">39: push reg[0] ;consult</span><br><span class="line">40: mov reg[1], 1</span><br><span class="line">41: add reg[2], reg[1] ;next input char</span><br><span class="line">42: jmp 11</span><br><span class="line"></span><br><span class="line">43: push 7 ;compare data</span><br><span class="line">44: push 13</span><br><span class="line">45: push 0</span><br><span class="line">46: push 5</span><br><span class="line">47: push 1</span><br><span class="line">48: push 12</span><br><span class="line">49: push 1</span><br><span class="line">50: push 0</span><br><span class="line">51: push 0</span><br><span class="line">52: push 13</span><br><span class="line">53: push 5</span><br><span class="line">54: push 15</span><br><span class="line">55: push 0</span><br><span class="line">56: push 9</span><br><span class="line">57: push 5</span><br><span class="line">58: push 15</span><br><span class="line">59: push 3</span><br><span class="line">60: push 0</span><br><span class="line">61: push 2</span><br><span class="line">62: push 5</span><br><span class="line">63: push 3</span><br><span class="line">64: push 3</span><br><span class="line">65: push 1</span><br><span class="line">66: push 7</span><br><span class="line">67: push 7</span><br><span class="line">68: push 11</span><br><span class="line">69: push 2</span><br><span class="line">70: push 1</span><br><span class="line">71: push 2</span><br><span class="line">72: push 7</span><br><span class="line">73: push 2</span><br><span class="line">74: push 12</span><br><span class="line">75: push 2</span><br><span class="line">76: push 2</span><br><span class="line"></span><br><span class="line">77: mov reg[2], 1</span><br><span class="line">78: load reg[1], stack[reg[2]]</span><br><span class="line">79: pop reg[0]</span><br><span class="line">80: zflag = reg[0] - reg[1] ;compare input char</span><br><span class="line">81: jnz 91</span><br><span class="line"></span><br><span class="line">82: mov reg[1], 34</span><br><span class="line">83: zflag = reg[2] - reg[1] ;set cycle index 34</span><br><span class="line">84: jz 89</span><br><span class="line"></span><br><span class="line">85: mov reg[1], 1</span><br><span class="line">86: add reg[2], reg[1] ;compare next char</span><br><span class="line">87: jmp 78</span><br><span class="line"></span><br><span class="line">88: mov reg[3], 0 </span><br><span class="line">89: print message ;print right</span><br><span class="line">90: exit</span><br><span class="line"></span><br><span class="line">91: mov reg[3], 1</span><br><span class="line">92: print message ;print wrong</span><br><span class="line">93: exit</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>根据上面代码的逻辑写出模拟的python代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">compare_data = [<span class="number">2</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">7</span>]</span><br><span class="line">flag = <span class="built_in">input</span>()</span><br><span class="line">result = []</span><br><span class="line">flag = [<span class="built_in">ord</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> flag]</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(flag) == <span class="number">17</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> flag:</span><br><span class="line">        <span class="keyword">if</span> i &gt;= <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>) <span class="keyword">and</span> i &lt;= <span class="built_in">ord</span>(<span class="string">&#x27;z&#x27;</span>):</span><br><span class="line">            i = ((i ^ <span class="number">71</span>) + <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        <span class="keyword">elif</span> i &gt;= <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) <span class="keyword">and</span> i &lt;= <span class="built_in">ord</span>(<span class="string">&#x27;Z&#x27;</span>):</span><br><span class="line">            i = ((i ^ <span class="number">75</span>) - <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line">        result.append(i % <span class="number">16</span>)</span><br><span class="line">        result.append(i // <span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="keyword">if</span> result == compare_data:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;right&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;wrong&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;wrong&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>然后再写出解密脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">compare_data = [<span class="number">2</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">7</span>]</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">34</span>, <span class="number">2</span>):</span><br><span class="line">    temp = compare_data[i] + compare_data[i+<span class="number">1</span>] * <span class="number">16</span></span><br><span class="line">    x = (temp - <span class="number">1</span>) ^ <span class="number">71</span></span><br><span class="line">    y = (temp + <span class="number">1</span>) ^ <span class="number">75</span></span><br><span class="line">    <span class="keyword">if</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">97</span>, <span class="number">123</span>):</span><br><span class="line">        flag += <span class="built_in">chr</span>(x)</span><br><span class="line">    <span class="keyword">elif</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">65</span>, <span class="number">91</span>):</span><br><span class="line">        flag += <span class="built_in">chr</span>(y)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flag += <span class="built_in">chr</span>(temp)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/ezvm&gt; python3 sim.py</span><br><span class="line">flag&#123;Such_A_EZVM&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>做完这道题，我对VM逆向有个大概的了解，VM的出题思路大致就是：编写一个指令集，设计一串opcode，实现一个将opcode和指令集联系起来的解释器</p>
<p>所以我们的做题思路就是：逆向指令集，搞清楚每个操作对应的行为，提取opcode，写出一个小的反汇编器，将opcode反汇编成能看懂的文本格式，逆向这个文本格式的代码，写出解题脚本</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>参考了SYJ学长的文章，附件也是在原文中下载</p>
<p>链接：<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-267670.htm">https://bbs.pediy.com/thread-267670.htm</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/" class="post-title-link" itemprop="url">CSAPP第七章</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-29 21:39:20" itemprop="dateCreated datePublished" datetime="2022-01-29T21:39:20+08:00">2022-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-02-01 17:20:34" itemprop="dateModified" datetime="2022-02-01T17:20:34+08:00">2022-02-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="7-1、编译器驱动程序"><a href="#7-1、编译器驱动程序" class="headerlink" title="7.1、编译器驱动程序"></a>7.1、编译器驱动程序</h2><p>编译器驱动程序可以理解为一个软件包，像linux中常用的gcc，它可以自动完成程序的预处理、编译、汇编、链接</p>
<p>先看两个示例程序：</p>
<p><strong>main.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> *a, <span class="keyword">int</span> n)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> val = sum(<span class="built_in">array</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>sum.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> *a, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, s = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s += a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在linux环境下使用命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gcc -Og -o prog main.c sum.c</span></span><br></pre></td></tr></table></figure>

<p>运行prog，程序返回3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7&gt; ./prog</span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7 [3]&gt; </span><br></pre></td></tr></table></figure>

<p>prog的生成过程如图所示：</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220129214757950.png" class="" title="image-20220129214757950">

<p>在这里gcc就是一个编译器驱动程序，它自动调用了cpp、cc1、as、ld等程序</p>
<h2 id="7-2、静态链接"><a href="#7-2、静态链接" class="headerlink" title="7.2、静态链接"></a>7.2、静态链接</h2><p>由ld完成，链接器主要做两件事：</p>
<ol>
<li>符号解析</li>
<li>重定位</li>
</ol>
<h2 id="7-3、目标文件"><a href="#7-3、目标文件" class="headerlink" title="7.3、目标文件"></a>7.3、目标文件</h2><p>目标文件有三种类型：</p>
<ol>
<li>可重定位目标文件，一般以.o结尾</li>
<li>可执行文件，一般以,out结尾</li>
<li>共享目标文件，一般以.so结尾</li>
</ol>
<p>可重定位和共享目标文件由编译器和汇编器生成，可执行目标文件由链接器生成</p>
<h2 id="7-4、可重定位目标文件"><a href="#7-4、可重定位目标文件" class="headerlink" title="7.4、可重定位目标文件"></a>7.4、可重定位目标文件</h2><img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220129220524465.png" class="" title="image-20220129220524465">

<p>一个典型的ELF可重定位目标文件格式如图所示</p>
<ol>
<li>ELF头：包含可重定位目标文件的大概信息</li>
<li>节头部表：包含可重定位目标文件的各个节的信息</li>
<li>.text段：代码段</li>
<li>.rodata段：只读数据段</li>
<li>.data段：数据段，存放初始化的全局变量和静态变量</li>
<li>.bss段：数据段，存放未初始化和初始化为零的全局变量和静态变量</li>
<li>.symtab段：符号表，保存全局变量的符号以及函数名称</li>
<li>.rel.text段：代码段的重定位信息</li>
<li>.rel.data段：数据段的重定位信息</li>
<li>.debug段：调试信息</li>
<li>.line段：源代码和机器代码的行号映射关系</li>
<li>.strtab段：字符串表</li>
</ol>
<h2 id="7-5、符号和符号表"><a href="#7-5、符号和符号表" class="headerlink" title="7.5、符号和符号表"></a>7.5、符号和符号表</h2><p>在链接器的上下文中有三种不同的符号：</p>
<ol>
<li>由本模块定义并能由其他模块引用的全局符号</li>
<li>由其他模块定义并能被本模块引用的全局符号</li>
<li>只被本模块定义和引用的局部符号</li>
</ol>
<p>static前缀代表该变量是私有的，如果在多个函数中定义同名的static变量，编译器会为其生成不同的符号</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220129223819540.png" class="" title="image-20220129223819540">

<ol>
<li>name：表示在符号表中的下标</li>
<li>type：函数或者数据</li>
<li>binding：本地或者全局</li>
<li>value：相对于本节区头的偏移</li>
</ol>
<p>符号表中的每个条目的组成如图所示，使用 <strong>readelf -s</strong> 可以查看我们之前生成的prog程序的符号表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7 [1]&gt; readelf -s prog</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.dynsym&#x27; contains 6 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab</span><br><span class="line">     2: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2.2.5 (2)</span><br><span class="line">     3: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">     4: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable</span><br><span class="line">     5: 0000000000000000     0 FUNC    WEAK   DEFAULT  UND __cxa_finalize@GLIBC_2.2.5 (2)</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 65 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1: 0000000000000318     0 SECTION LOCAL  DEFAULT    1 </span><br><span class="line">     2: 0000000000000338     0 SECTION LOCAL  DEFAULT    2 </span><br><span class="line">     3: 0000000000000358     0 SECTION LOCAL  DEFAULT    3 </span><br><span class="line">     4: 000000000000037c     0 SECTION LOCAL  DEFAULT    4 </span><br><span class="line">     5: 00000000000003a0     0 SECTION LOCAL  DEFAULT    5 </span><br><span class="line">     6: 00000000000003c8     0 SECTION LOCAL  DEFAULT    6 </span><br><span class="line">     7: 0000000000000458     0 SECTION LOCAL  DEFAULT    7 </span><br><span class="line">     8: 00000000000004d6     0 SECTION LOCAL  DEFAULT    8 </span><br><span class="line">     9: 00000000000004e8     0 SECTION LOCAL  DEFAULT    9 </span><br><span class="line">    10: 0000000000000508     0 SECTION LOCAL  DEFAULT   10 </span><br><span class="line">    11: 0000000000001000     0 SECTION LOCAL  DEFAULT   11 </span><br><span class="line">    12: 0000000000001020     0 SECTION LOCAL  DEFAULT   12 </span><br><span class="line">    13: 0000000000001030     0 SECTION LOCAL  DEFAULT   13 </span><br><span class="line">    14: 0000000000001040     0 SECTION LOCAL  DEFAULT   14 </span><br><span class="line">    15: 00000000000011e8     0 SECTION LOCAL  DEFAULT   15 </span><br><span class="line">    16: 0000000000002000     0 SECTION LOCAL  DEFAULT   16 </span><br><span class="line">    17: 0000000000002004     0 SECTION LOCAL  DEFAULT   17 </span><br><span class="line">    18: 0000000000002048     0 SECTION LOCAL  DEFAULT   18 </span><br><span class="line">    19: 0000000000003df0     0 SECTION LOCAL  DEFAULT   19 </span><br><span class="line">    20: 0000000000003df8     0 SECTION LOCAL  DEFAULT   20 </span><br><span class="line">    21: 0000000000003e00     0 SECTION LOCAL  DEFAULT   21 </span><br><span class="line">    22: 0000000000003fc0     0 SECTION LOCAL  DEFAULT   22 </span><br><span class="line">    23: 0000000000004000     0 SECTION LOCAL  DEFAULT   23 </span><br><span class="line">    24: 0000000000004018     0 SECTION LOCAL  DEFAULT   24 </span><br><span class="line">    25: 0000000000000000     0 SECTION LOCAL  DEFAULT   25 </span><br><span class="line">    26: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c</span><br><span class="line">    27: 0000000000001070     0 FUNC    LOCAL  DEFAULT   14 deregister_tm_clones</span><br><span class="line">    28: 00000000000010a0     0 FUNC    LOCAL  DEFAULT   14 register_tm_clones</span><br><span class="line">    29: 00000000000010e0     0 FUNC    LOCAL  DEFAULT   14 __do_global_dtors_aux</span><br><span class="line">    30: 0000000000004018     1 OBJECT  LOCAL  DEFAULT   24 completed.8061</span><br><span class="line">    31: 0000000000003df8     0 OBJECT  LOCAL  DEFAULT   20 __do_global_dtors_aux_fin</span><br><span class="line">    32: 0000000000001120     0 FUNC    LOCAL  DEFAULT   14 frame_dummy</span><br><span class="line">    33: 0000000000003df0     0 OBJECT  LOCAL  DEFAULT   19 __frame_dummy_init_array_</span><br><span class="line">    34: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS main.c</span><br><span class="line">    35: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS sum.c</span><br><span class="line">    36: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c</span><br><span class="line">    37: 0000000000002144     0 OBJECT  LOCAL  DEFAULT   18 __FRAME_END__</span><br><span class="line">    38: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS </span><br><span class="line">    39: 0000000000003df8     0 NOTYPE  LOCAL  DEFAULT   19 __init_array_end</span><br><span class="line">    40: 0000000000003e00     0 OBJECT  LOCAL  DEFAULT   21 _DYNAMIC</span><br><span class="line">    41: 0000000000003df0     0 NOTYPE  LOCAL  DEFAULT   19 __init_array_start</span><br><span class="line">    42: 0000000000002004     0 NOTYPE  LOCAL  DEFAULT   17 __GNU_EH_FRAME_HDR</span><br><span class="line">    43: 0000000000003fc0     0 OBJECT  LOCAL  DEFAULT   22 _GLOBAL_OFFSET_TABLE_</span><br><span class="line">    44: 0000000000001000     0 FUNC    LOCAL  DEFAULT   11 _init</span><br><span class="line">    45: 00000000000011e0     5 FUNC    GLOBAL DEFAULT   14 __libc_csu_fini</span><br><span class="line">    46: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab</span><br><span class="line">    47: 0000000000004000     0 NOTYPE  WEAK   DEFAULT   23 data_start</span><br><span class="line">    48: 0000000000004010     8 OBJECT  GLOBAL DEFAULT   23 array</span><br><span class="line">    49: 0000000000004018     0 NOTYPE  GLOBAL DEFAULT   23 _edata</span><br><span class="line">    50: 00000000000011e8     0 FUNC    GLOBAL HIDDEN    15 _fini</span><br><span class="line">    51: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@@GLIBC_</span><br><span class="line">    52: 0000000000004000     0 NOTYPE  GLOBAL DEFAULT   23 __data_start</span><br><span class="line">    53: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">    54: 0000000000004008     0 OBJECT  GLOBAL HIDDEN    23 __dso_handle</span><br><span class="line">    55: 0000000000001147    32 FUNC    GLOBAL DEFAULT   14 sum</span><br><span class="line">    56: 0000000000002000     4 OBJECT  GLOBAL DEFAULT   16 _IO_stdin_used</span><br><span class="line">    57: 0000000000001170   101 FUNC    GLOBAL DEFAULT   14 __libc_csu_init</span><br><span class="line">    58: 0000000000004020     0 NOTYPE  GLOBAL DEFAULT   24 _end</span><br><span class="line">    59: 0000000000001040    47 FUNC    GLOBAL DEFAULT   14 _start</span><br><span class="line">    60: 0000000000004018     0 NOTYPE  GLOBAL DEFAULT   24 __bss_start</span><br><span class="line">    61: 0000000000001129    30 FUNC    GLOBAL DEFAULT   14 main</span><br><span class="line">    62: 0000000000004018     0 OBJECT  GLOBAL HIDDEN    23 __TMC_END__</span><br><span class="line">    63: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable</span><br><span class="line">    64: 0000000000000000     0 FUNC    WEAK   DEFAULT  UND __cxa_finalize@@GLIBC_2.2</span><br></pre></td></tr></table></figure>

<p>COMMON和.bss的区别：</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220129224728917.png" class="" title="image-20220129224728917">



<h2 id="7-6、符号解析"><a href="#7-6、符号解析" class="headerlink" title="7.6、符号解析"></a>7.6、符号解析</h2><p>符号解析是链接器的工作，编译器为程序生成符号，链接器通过解析这些符号来确定程序中的引用</p>
<p>对于局部符号，编译器直接生成与原来一样的符号，但是对于全局符号，这个过程就比较复杂，因为在全局符号中可能存在一样的符号</p>
<p>C++中的函数重载就涉及这个问题，两个函数有一样的函数名，但确实是不同的函数，C++的编译器使用了一种叫做符号修饰的方法</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130132342288.png" class="" title="image-20220130132342288">

<h3 id="7-6-1、链接器如何解析多重定义的全局符号"><a href="#7-6-1、链接器如何解析多重定义的全局符号" class="headerlink" title="7.6.1、链接器如何解析多重定义的全局符号"></a>7.6.1、链接器如何解析多重定义的全局符号</h3><p>编译器输出的符号分为强符号和弱符号</p>
<p>函数和已初始化的全局变量是强符号，未初始化的全局变量是弱符号</p>
<p>当一个程序中存在多重定义的全局符号时，链接器遵循以下原则：</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130135928922.png" class="" title="image-20220130135928922">

<h3 id="7-6-2、与静态库链接"><a href="#7-6-2、与静态库链接" class="headerlink" title="7.6.2、与静态库链接"></a>7.6.2、与静态库链接</h3><p>静态库相当于一个模块的集合，使用静态链接是，链接器会将程序中引用的模块从静态库中链接出来，而程序中没有引用的模块，链接器则不做处理</p>
<p><strong>addvec.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> addcnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addvec</span><span class="params">(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y, <span class="keyword">int</span> *z, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    addcnt++;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        z[i] = x[i] + y[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>multvec.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> multcnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">multvec</span><span class="params">(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y, <span class="keyword">int</span> *z, <span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    multcnt++;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        z[i] = x[i] * y[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用ar将这两个模块合并到一个静态库中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7&gt; gcc -c addvec.c multvec.c </span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7&gt; ar rcs libvector.a addvec.o multvec.o</span><br></pre></td></tr></table></figure>

<p>使用nm查看libvector.a中的符号：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7&gt; nm libvector.a </span><br><span class="line"></span><br><span class="line">addvec.o:</span><br><span class="line">0000000000000000 B addcnt</span><br><span class="line">0000000000000000 T addvec</span><br><span class="line"></span><br><span class="line">multvec.o:</span><br><span class="line">0000000000000000 B multcnt</span><br><span class="line">0000000000000000 T multvec</span><br></pre></td></tr></table></figure>

<p><strong>vector.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addvec</span><span class="params">(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y, <span class="keyword">int</span> *z, <span class="keyword">int</span> n)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">multvec</span><span class="params">(<span class="keyword">int</span> *x, <span class="keyword">int</span> *y, <span class="keyword">int</span> *z, <span class="keyword">int</span> n)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在main函数中引用addvec函数，最后静态链接起来</p>
<p><strong>main2.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&quot;vector.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> x[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> y[<span class="number">2</span>] = &#123;<span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> z[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    addvec(x, y, z, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;z = [%d, %d]\n&quot;</span>, z[<span class="number">0</span>], z[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7&gt; gcc -c main2.c</span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7&gt; gcc -static -o prog2 main2.o ./libvector.a</span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7&gt; ./prog2</span><br><span class="line">z = [4, 6]</span><br></pre></td></tr></table></figure>

<p>链接过程中，gcc只会将addvec模块链接进程序，而不会理会multvec，这大大减小了程序占用的磁盘空间和运行时的内存</p>
<p>prog2的生成过程：</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130194449949.png" class="" title="image-20220130194449949">

<h3 id="7-6-2、链接器如何使用静态库来解析引用"><a href="#7-6-2、链接器如何使用静态库来解析引用" class="headerlink" title="7.6.2、链接器如何使用静态库来解析引用"></a>7.6.2、链接器如何使用静态库来解析引用</h3><p>需要注意的是：使用编译器驱动程序生成可执行程序时，命令行中文件的顺序是有要求的，符号的引用必须在定义之前</p>
<p>假设main.c引用了libx.a存档中的符号，那么在命令行中，main.c和libx.c的顺序必须是main.c在前，否则会产生报错</p>
<h2 id="7-7、重定位"><a href="#7-7、重定位" class="headerlink" title="7.7、重定位"></a>7.7、重定位</h2><p>重定位分为两步：</p>
<ol>
<li>重定位节和符号定义</li>
<li>重定位节中的符号引用</li>
</ol>
<h3 id="7-7-1、重定位条目"><a href="#7-7-1、重定位条目" class="headerlink" title="7.7.1、重定位条目"></a>7.7.1、重定位条目</h3><p>重定位条目是由汇编器生成的，指导链接器完成符号引用的重定位，.text的重定位条目位于.rel.text</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130200519697.png" class="" title="image-20220130200519697">



<p>重定位条目中的每个元素如图所示</p>
<p>下图是elf文件中最基本的两种重定位类型，第一种可以理解为偏移地址重定位，第二种可以理解为绝对地址重定位</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130200658026.png" class="" title="image-20220130200658026">

<h3 id="7-7-2、重定位符号引用"><a href="#7-7-2、重定位符号引用" class="headerlink" title="7.7.2、重定位符号引用"></a>7.7.2、重定位符号引用</h3><p>重定位算法如图所示：</p>
<p>遍历节区和节区中的重定位条目，然后计算重定位符号引用的地址，然后根据重定位类型进入不同的if语句块</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130203337366.png" class="" title="image-20220130203337366">



<h2 id="7-8、可执行目标文件"><a href="#7-8、可执行目标文件" class="headerlink" title="7.8、可执行目标文件"></a>7.8、可执行目标文件</h2><img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130204219349.png" class="" title="image-20220130204219349">

<p>可执行目标文件被映射到内存中时，相同权限的节区会被映射到一个段，上图的文件在内存中的段布局：</p>
<p>一个只读段，一个可读可写段</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130210041634.png" class="" title="image-20220130210041634">

<h2 id="7-9、加载可执行目标文件"><a href="#7-9、加载可执行目标文件" class="headerlink" title="7.9、加载可执行目标文件"></a>7.9、加载可执行目标文件</h2><p>可执行文件加载到内存后，会在内存中生成一个映像，这个映像中不仅有可执行文件的副本，还有诸如堆、栈等运行时所需结构</p>
<p>以及共享库和内核的代码，加载的过程由加载器完成，它将可执行文件的内容复制到内存中并将控制权转交给程序</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130210750870.png" class="" title="image-20220130210750870">



<h2 id="7-10、动态链接共享库"><a href="#7-10、动态链接共享库" class="headerlink" title="7.10、动态链接共享库"></a>7.10、动态链接共享库</h2><p>还记得我们之前使用过的示例程序吗？</p>
<p>这一次我们让其使用共享库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7&gt; gcc -shared -fpic -o libcvector.so addvec.c multvec.c </span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7&gt; gcc -o prog21 main2.c ./libcvector.so </span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/c/chapter7&gt; ./prog21</span><br><span class="line">z = [4, 6]</span><br></pre></td></tr></table></figure>

<p>程序的构建和运行过程如图所示：</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130212706853.png" class="" title="image-20220130212706853">

<p>相比于静态链接，动态链接更节省空间和内存，动态链接库一直保存在内存中，当有程序应用共享库中的模块时，它可以在自己的虚拟空间创建共享库的副本，程序结束后，这个副本也随之消失，就是说内存中只需要保留一份共享库代码就i可以供所有程序使用</p>
<p>如图所示，在形成可执行目标文件时，并不会有libc.so和libvector.so的代码被复制到可执行文件中，链接器只是重定位main2.o中的符号引用</p>
<p>在程序运行时，动态链接器将libc.so和libvector.so的代码复制到本进程的虚拟空间，然后重定位可执行文件中的符号引用，最后将控制权转交给程序</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220130214906367.png" class="" title="image-20220130214906367">



<h2 id="7-11、从应用程序中加载和链接共享库"><a href="#7-11、从应用程序中加载和链接共享库" class="headerlink" title="7.11、从应用程序中加载和链接共享库"></a>7.11、从应用程序中加载和链接共享库</h2><p>C和C++提供了几个函数，可以在程序运行过程中加载和链接共享库，并在使用完之后卸载</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220201132634494.png" class="" title="image-20220201132634494">

<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220201132652607.png" class="" title="image-20220201132652607">

<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220201132729805.png" class="" title="image-20220201132729805">

<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220201132743621.png" class="" title="image-20220201132743621">

<p>示例程序：</p>
<p><strong>prog2r.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> x[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> y[<span class="number">2</span>] = &#123;<span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> z[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *handle;</span><br><span class="line">    <span class="keyword">void</span> (*addvec)(<span class="keyword">int</span> *, <span class="keyword">int</span> *, <span class="keyword">int</span>*, <span class="keyword">int</span>);</span><br><span class="line">    <span class="keyword">char</span> *error;</span><br><span class="line"></span><br><span class="line">    handle = dlopen(<span class="string">&quot;/home/yiqiu/Codefile/csapp/chapter7/libcvector.so&quot;</span>, RTLD_LAZY); <span class="comment">//加载共享库</span></span><br><span class="line">    <span class="keyword">if</span>(!handle) <span class="comment">//判断是否加载成功</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>, dlerror());</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addvec = dlsym(handle, <span class="string">&quot;addvec&quot;</span>); <span class="comment">//引用共享库中的符号</span></span><br><span class="line">    <span class="keyword">if</span>((error = dlerror()) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>, error);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addvec(x, y, z, <span class="number">2</span>); <span class="comment">//调用共享库中的函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(dlclose(handle) &lt; <span class="number">0</span>) <span class="comment">//卸载共享库</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>, dlerror());</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp [1]&gt; gcc -rdynamic -o prog2r.out prog2r.c -ldl</span><br></pre></td></tr></table></figure>

<p>java调用本地C/C++函数的实现方法：</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220201133154258.png" class="" title="image-20220201133154258">

<h2 id="7-12、位置无关代码"><a href="#7-12、位置无关代码" class="headerlink" title="7.12、位置无关代码"></a>7.12、位置无关代码</h2><p>位置无关代码的作用是允许多个进程使用一个共享库代码的副本而不造成内存浪费，在gcc编译时使用-fpic选项指定生成位置无关代码</p>
<p>1、PIC数据引用</p>
<p>在共享库中，数据和代码的之间偏移是固定的，共享库中的代码被动态连接到内存中时，动态链接器还会根据一个全局偏移量表（GOT）来重定位代码中的数据引用</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220201151603208.png" class="" title="image-20220201151603208">

<p>2、PIC函数调用</p>
<img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220201152227790.png" class="" title="image-20220201152227790">

<p>PIC函数调用通过GOT表、PLT表和延迟绑定机制来实现</p>
<p>函数没有被调用前，GOT表中的地址并不是函数的真正地址，而是对应PIL表中的第二条代码，函数第一次被调用时，经过一系列操作，会将函数的真实地址写入GOT表，以后调用时就可知直接跳转到函数的地址了</p>
<p><strong>第一次调用addvec</strong></p>
<ol>
<li>call指令调用函数</li>
<li>跳转到PLT表</li>
<li>跳转到GOT表指定的位置，即PLT表中的下一条指令</li>
<li>pushq压入addvec函数的序号</li>
<li>跳转到PLT[0]</li>
<li>调用动态加载器</li>
<li>执行函数并将函数的地址写入GOT表</li>
</ol>
<p><strong>第二次调用addvec</strong></p>
<ol>
<li>call指令调用函数</li>
<li>跳转到PLT表</li>
<li>跳转到GOT表指定的位置，即函数位置</li>
</ol>
<h2 id="7-13、库打桩机制"><a href="#7-13、库打桩机制" class="headerlink" title="7.13、库打桩机制"></a>7.13、库打桩机制</h2><p>按书中的描述，打桩就是hook，将库函数更换为你自己编写的函数</p>
<h3 id="7-13-1、编译时打桩"><a href="#7-13-1、编译时打桩" class="headerlink" title="7.13.1、编译时打桩"></a>7.13.1、编译时打桩</h3><p>示例代码：</p>
<p><strong>int.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> *p = <span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>malloc.h</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> malloc(size) mymalloc(size)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> free(ptr) myfree(ptr)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">mymalloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfree</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>mymalloc.c</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILETIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">mymalloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(%d)=%p\n&quot;</span>, (<span class="keyword">int</span>)size, ptr);</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myfree</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;free(%p)\n&quot;</span>, ptr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp [1]&gt; gcc -DCOMPILETIME -c mymalloc.c</span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp&gt; gcc -I. -o intc int.c mymalloc.o</span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp&gt; ./intc </span><br><span class="line">malloc(32)=0x55848446c2a0</span><br><span class="line">free(0x55848446c2a0)</span><br></pre></td></tr></table></figure>

<p>关键代码在malloc.h中，将malloc函数替换为mymalloc函数，将free函数替换为myfree函数</p>
<p>编译后，调用malloc函数就相当于调用mymalloc函数，free函数同理</p>
<h3 id="7-13-2、链接时打桩"><a href="#7-13-2、链接时打桩" class="headerlink" title="7.13.2、链接时打桩"></a>7.13.2、链接时打桩</h3><p>使用–wrap f将f替换为__wrap_f，而__real_f会被替换为f</p>
<p>修改mymalloc.c代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LINKTIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span>* __wrap_malloc(<span class="keyword">size_t</span> size)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> *ptr = __real_malloc(size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(%d)=%p\n&quot;</span>, (<span class="keyword">int</span>)size, ptr);</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __wrap_free(<span class="keyword">void</span> *ptr)</span><br><span class="line">&#123;</span><br><span class="line">    __real_free(ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;free(%p)\n&quot;</span>, ptr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp&gt; gcc -DLINKTIME -c mymalloc.c</span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp&gt; gcc -c int.c </span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp&gt; gcc -WL,--wrap,malloc -WL,--wrap,free -o intl int.o mymalloc.o</span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp [1]&gt; gcc -Wl,--wrap,malloc -Wl,--wrap,free -o intl int.o mymalloc.o</span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp&gt; ./intl</span><br><span class="line">malloc(32)=0x55aa635022a0</span><br><span class="line">free(0x55aa635022a0)</span><br></pre></td></tr></table></figure>

<h3 id="7-13-3、运行时打桩"><a href="#7-13-3、运行时打桩" class="headerlink" title="7.13.3、运行时打桩"></a>7.13.3、运行时打桩</h3><p>编译时打桩需要源代码，链接时打桩需要目标文件，但是运行时打桩只需要可执行文件</p>
<p>LD_PRELOAD环境变量可以设置可执行程序优先加载的共享库</p>
<p>修改mymalloc.c的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RUNTIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> calltimes; <span class="comment">//默认初始化为0</span></span><br><span class="line">    calltimes++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* (*mallocp)(<span class="keyword">size_t</span> size);</span><br><span class="line">    <span class="keyword">char</span> *error;</span><br><span class="line">    mallocp = dlsym(RTLD_NEXT, <span class="string">&quot;malloc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((error = dlerror()) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(error, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> *ptr = mallocp(size);</span><br><span class="line">    <span class="keyword">if</span>(calltimes == <span class="number">1</span>) <span class="comment">//避免重复调用</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;malloc(%d)=%p\n&quot;</span>, (<span class="keyword">int</span>)size, ptr);</span><br><span class="line">    calltimes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> calltimes;</span><br><span class="line">    calltimes++;</span><br><span class="line">    <span class="keyword">void</span> (*freep)(<span class="keyword">void</span> *) = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> *error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!ptr)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    freep = dlsym(RTLD_NEXT, <span class="string">&quot;free&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((error = dlerror()) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(error, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    freep(ptr);</span><br><span class="line">    <span class="keyword">if</span>(calltimes == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;free(%p)\n&quot;</span>, ptr);</span><br><span class="line">    calltimes = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp [SIGSEGV]&gt; gcc -DRUNTIME -shared -fpic -o mymalloc.so mymalloc.c -ldl</span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp&gt; gcc -o intr int.c</span><br><span class="line">yiqiu@LAPTOP-I2IQS5DP ~/C/csapp&gt; LD_PRELOAD=./mymalloc.so ./intr</span><br><span class="line">malloc(32)=0x55ef433352a0</span><br><span class="line">free(0x55ef433352a0)</span><br></pre></td></tr></table></figure>

<h2 id="7-14、处理目标文件的工具"><a href="#7-14、处理目标文件的工具" class="headerlink" title="7.14、处理目标文件的工具"></a>7.14、处理目标文件的工具</h2><img src="/2022/01/29/CSAPP%E7%AC%AC%E4%B8%83%E7%AB%A0/image-20220201172032760.png" class="" title="image-20220201172032760">

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/29/ida%E9%80%86%E5%90%91%E5%88%86%E6%9E%90main%E4%B9%8B%E5%89%8D%E7%9A%84%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/29/ida%E9%80%86%E5%90%91%E5%88%86%E6%9E%90main%E4%B9%8B%E5%89%8D%E7%9A%84%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">ida逆向分析main之前的函数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-01-29 19:09:06 / Modified: 20:03:52" itemprop="dateCreated datePublished" datetime="2022-01-29T19:09:06+08:00">2022-01-29</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>我们常说程序的入口点是main函数</p>
<p>但是main函数真的是程序开始的地方吗？</p>
<p>答案是：不是，start函数才是，这篇blog旨在分析main函数进行之前，程序都做了哪些事</p>
<p>将示例程序拖进ida，查看start函数的伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">start</span><span class="params">(__int64 a1, __int64 a2, <span class="keyword">void</span> (*a3)(<span class="keyword">void</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// esi</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp-8h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> *retaddr; <span class="comment">// [rsp+0h] [rbp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v4 = v5;</span><br><span class="line">  v5 = v3;</span><br><span class="line">  _libc_start_main((<span class="keyword">int</span> (__fastcall *)(<span class="keyword">int</span>, <span class="keyword">char</span> **, <span class="keyword">char</span> **))main, v4, &amp;retaddr, (<span class="keyword">void</span> (*)(<span class="keyword">void</span>))init, fini, a3, &amp;v5);</span><br><span class="line">  __halt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到：start函数内部调用了libc_start_main函数，这个函数有7个参数</p>
<p>我们只关心其中两个：</p>
<p>第一个参数是main函数的函数指针，有了这个参数，libc_start_main才能调用main函数</p>
<p>第四个参数是init函数的指针，init函数就是我们此次重点关注的对象</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">init</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 v4; <span class="comment">// rbp</span></span><br><span class="line">  __int64 i; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  init_proc();</span><br><span class="line">  v4 = &amp;off_55DFEAA3FD70 - funcs_1E69;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != v4; ++i )</span><br><span class="line">      ((<span class="keyword">void</span> (__fastcall *)(_QWORD, __int64, __int64))funcs_1E69[i])(a1, a2, a3);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>init函数中首先调用了init_proc函数，这个函数里面又调用了gmon_start函数，这个函数用来生成profile文件，在逆向中我们不需要关注它</p>
<p>通常，在init_proc函数中还会调用全局构造函数_do_global_ctors_aux</p>
<p>这个函数的源代码如下：</p>
<p>他会循环调用所有全局构造函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__do_global_ctors_aux (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  func_ptr *p;</span><br><span class="line">  <span class="keyword">for</span> (p = __CTOR_END__ - <span class="number">1</span>; *p != (func_ptr) <span class="number">-1</span>; p--)</span><br><span class="line">    (*p) ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 (**init_proc())(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 (**result)(<span class="keyword">void</span>); <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = &amp;_gmon_start__;</span><br><span class="line">  <span class="keyword">if</span> ( &amp;_gmon_start__ )</span><br><span class="line">    <span class="keyword">return</span> (__int64 (**)(<span class="keyword">void</span>))_gmon_start__();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在init函数中，再往下就是一个循环，首先得到v4的值，然后如果i不等于v4，就依次调用funcs_1E69这个函数指针数组中的函数，这个数组里保存的是用户自定义的函数，这个例题中有两个自定义函数</p>
<img src="/2022/01/29/ida%E9%80%86%E5%90%91%E5%88%86%E6%9E%90main%E4%B9%8B%E5%89%8D%E7%9A%84%E5%87%BD%E6%95%B0/image-20220129195436027.png" class="" title="image-20220129195436027">

<p>第一个函数啥也没做，只是返回一个0</p>
<p>第二个函数的伪代码如下：</p>
<p>作用是检查程序是否处于调试环境，如果不是，就将”w0wy0ugot1t”这个字符串粘贴到aHappyhg4me位置</p>
<p>而这个位置保存的是main函数中一个加密算法的密钥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">sub_55DFEAA3DC27</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+4h] [rbp-7Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *i; <span class="comment">// [rsp+8h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">104</span>]; <span class="comment">// [rsp+10h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fd = open(<span class="string">&quot;/proc/self/status&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  read(fd, buf, <span class="number">0x64</span>uLL);</span><br><span class="line">  <span class="keyword">for</span> ( i = buf; *i != <span class="string">&#x27;T&#x27;</span> || i[<span class="number">1</span>] != <span class="string">&#x27;r&#x27;</span> || i[<span class="number">2</span>] != <span class="string">&#x27;a&#x27;</span> || i[<span class="number">3</span>] != <span class="string">&#x27;c&#x27;</span> || i[<span class="number">4</span>] != <span class="string">&#x27;e&#x27;</span> || i[<span class="number">5</span>] != <span class="string">&#x27;r&#x27;</span>; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( !atoi(i + <span class="number">11</span>) )</span><br><span class="line">    <span class="built_in">strcpy</span>(aHappyhg4me, <span class="string">&quot;w0wy0ugot1t&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在逆向过程中，这里存放的自定义通常是用来反调试的，建议每次都看看里面有没有什么东西</p>
<p>做完这些事，init函数返回到libc_start_main函数，接着就是由libc_start_main函数调用main函数，在逆向中，主要要注意的就是main函数之前的init函数</p>
<p>里面可能存放着一些关键代码</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
